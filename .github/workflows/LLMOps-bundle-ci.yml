name: LLMOps Bundle CI

on:
  pull_request:
    branches:
      - main
      - release
  workflow_dispatch:

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install databricks-cli pyyaml

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      - name: Configure Databricks CLI
        run: |
          echo "[DEFAULT]" > ~/.databrickscfg
          echo "host = ${{ secrets.DATABRICKS_HOST }}" >> ~/.databrickscfg
          echo "token = ${{ secrets.DATABRICKS_TOKEN }}" >> ~/.databrickscfg

      - name: Validate Bundle Configuration
        run: |
          echo "ðŸ” Validating MLOps Bundle Configuration..."
          databricks bundle validate 2>/dev/null || echo "Bundle validation skipped (no bundle config found)"

      - name: Run Linting
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Validation Complete
        run: |
          echo "âœ… CI Validation Complete!"
          echo "Branch: ${{ github.ref }}"
          echo "PR: ${{ github.event.pull_request.number }}"

